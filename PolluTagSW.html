<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Web Serial API - PM Sensor Monitor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #output { background: #000; color: #0f0; padding: 10px; height: 150px; overflow-y: scroll; font-family: monospace; white-space: pre-wrap; }
    canvas { margin-top: 20px; }
    .widgets { display: flex; gap: 20px; margin-top: 20px; }
    .widget { border: 1px solid #ccc; padding: 10px; border-radius: 8px; min-width: 100px; background: #f9f9f9; }
  </style>
</head>
<body>
  <h1>PM Sensor Monitor via Web Serial</h1>
  <div>
    <label>Baud Rate:</label>
    <select id="baudRate">
      <option value="9600">9600</option>
      <option value="19200">19200</option>
      <option value="38400">38400</option>
      <option value="57600">57600</option>
      <option value="115200" selected>115200</option>
    </select>
    <label>Data Bits:</label>
    <select id="dataBits">
      <option value="7">7</option>
      <option value="8" selected>8</option>
    </select>
    <label>Stop Bits:</label>
    <select id="stopBits">
      <option value="1" selected>1</option>
      <option value="2">2</option>
    </select>
    <label>Parity:</label>
    <select id="parity">
      <option value="none" selected>None</option>
      <option value="even">Even</option>
      <option value="odd">Odd</option>
    </select>
    <button id="request-port">Request Port</button>
    <button id="open-port">Open Port & Read</button>
    <button id="close-port">Close Port</button>
    <button id="download-csv">Download CSV Log</button>
  </div>
  <div class="widgets">
    <div class="widget">PM1: <span id="pm1">--</span></div>
    <div class="widget">PM2.5: <span id="pm25">--</span></div>
    <div class="widget">PM10: <span id="pm10">--</span></div>
  </div>
  <canvas id="chart" width="800" height="300"></canvas>
  <pre id="output"></pre>

  <script>
    let port, reader;
    let buffer = [];
    let logData = [];
    const output = document.getElementById('output');
    const pm1El = document.getElementById('pm1');
    const pm25El = document.getElementById('pm25');
    const pm10El = document.getElementById('pm10');

    const chart = new Chart(document.getElementById('chart').getContext('2d'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'PM1', borderColor: 'blue', data: [], fill: false },
          { label: 'PM2.5', borderColor: 'green', data: [], fill: false },
          { label: 'PM10', borderColor: 'red', data: [], fill: false },
        ]
      },
      options: {
        animation: false,
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Time' } },
          y: { beginAtZero: true }
        }
      }
    });

    function log(text) {
      output.textContent += text + '\n';
      output.scrollTop = output.scrollHeight;
    }

    function updateChart(pm1, pm25, pm10) {
      const time = new Date().toLocaleTimeString();
      chart.data.labels.push(time);
      chart.data.datasets[0].data.push(pm1);
      chart.data.datasets[1].data.push(pm25);
      chart.data.datasets[2].data.push(pm10);
      if (chart.data.labels.length > 100) {
        chart.data.labels.shift();
        chart.data.datasets.forEach(ds => ds.data.shift());
      }
      chart.update('none');
    }

    function parseFrame(frame) {
      const view = new DataView(new Uint8Array(frame).buffer);
      // XOR checksum of bytes 2 through 30 (indexes 1 to 29)
      let checksum = 0;
      for (let i = 1; i <= 29; i++) checksum ^= view.getUint8(i);
      const receivedChecksum = view.getUint8(30);

      if (checksum !== receivedChecksum) {
        log('❌ Invalid checksum. Skipping frame.');
        return;
      }

      const pm1 = view.getUint32(1, true);
      const pm25 = view.getUint32(5, true);
      const pm10 = view.getUint32(9, true);
      pm1El.textContent = pm1;
      pm25El.textContent = pm25;
      pm10El.textContent = pm10;
      updateChart(pm1, pm25, pm10);
      logData.push([new Date().toLocaleTimeString(), pm1, pm25, pm10]);
    }

    function handleData(bytes) {
      buffer.push(...bytes);
      while (buffer.length >= 32) {
        if (buffer[0] === 0x02 && buffer[31] === 0x03) {
          const frame = buffer.slice(0, 32);
          buffer = buffer.slice(32);
          parseFrame(frame);
          log('Frame: ' + frame.map(b => b.toString(16).padStart(2, '0')).join(' '));
        } else {
          buffer.shift();
        }
      }
    }

    document.getElementById('request-port').addEventListener('click', async () => {
      try {
        port = await navigator.serial.requestPort();
        log('✅ Port selected.');
      } catch (err) {
        log('❌ ' + err);
      }
    });

    document.getElementById('open-port').addEventListener('click', async () => {
      if (!port) return log('⚠️ No port selected.');
      try {
        await port.open({
          baudRate: +document.getElementById('baudRate').value,
          dataBits: +document.getElementById('dataBits').value,
          stopBits: +document.getElementById('stopBits').value,
          parity: document.getElementById('parity').value
        });
        log('🔌 Port opened.');
        reader = port.readable.getReader();
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) handleData(value);
        }
      } catch (err) {
        log('❌ Error: ' + err);
      }
    });

    document.getElementById('close-port').addEventListener('click', async () => {
      if (reader) {
        await reader.cancel();
        reader.releaseLock();
        log('🛑 Reader cancelled.');
      }
      if (port) {
        await port.close();
        log('🔒 Port closed.');
      }
    });

    document.getElementById('download-csv').addEventListener('click', () => {
      const rows = ["Time,PM1,PM2.5,PM10"].concat(logData.map(d => d.join(',')));
      const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'pm_log.csv';
      a.click();
    });
  </script>
</body>
</html>






