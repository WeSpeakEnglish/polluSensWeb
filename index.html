<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>polluSensWeb Chart</title>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
		<link rel="stylesheet" href="styles.css">
		<style> 
h1 {
    font-family: "Inter", system-ui, sans-serif;
    font-size: 2.2rem;
    font-weight: 500;
    color: #0f172a;
    border-left: 4px solid #2563eb;
    padding-left: 0.75rem;
    margin-bottom: 1.2rem;

    /* visible but still professional */
    text-shadow:
        0 1px 0 rgba(255, 255, 255, 0.4),
        0 2px 3px rgba(0, 0, 0, 0.25);
}
		</style>
	</head>
	<body>
		<header>
			<h1><b>polluSensWeb</b><br/>Connect your UART pollution sensor directly in your browser. Easy.</h1>
			<div>
				<select id="sensorSelector"></select>
				<button id="connect">ðŸ”Œ Connect</button>
				<br/>
				<label>Custom JSON Sensor Configuration: <input type="file" id="jsonUpload" accept=".json" class="secondary-button" /></label>
			</div>
		</header>
		
		<div id="chartControls">
			<h3>Create a Chart</h3>
			<div class="chartParams">
				<label>Chart name:<input type="text" id="chartName" value="Chart" /></label>
				<label>Width:<input type="number" id="chartWidth" value="600" /></label>
				<label>Height:<input type="number" id="chartHeight" value="300" /></label>
				<label>Chart datapoints:<input type="number" id="maxDatapoints" value="600" min="2" /></label>
			</div>
			<div id="datasetConfigs"><h4>Signals</h4><div id="signalRows"></div></div>
			<button id="createChart">ðŸ“ˆ Create Chart</button>
		</div>
		
		<div id="charts"></div>
		
		<div style="margin-bottom: 8px;">
			<label><b>Log:</b></label>
			<label>Display last <input type="number" id="maxLogPackets" value="1000" min="10" style="width:80px;" /> lines</label>
			<label style="margin-left:20px;"><input type="checkbox" id="autoscrollLog" checked /> Autoscroll</label>
			<button id="clearLog" class="secondary-button">ðŸ§¹ Clear Log</button>
			<button id="saveCSV" class="secondary-button">ðŸ’¾ Save CSV</button>
		</div>
		
		<pre id="log"></pre>
		
		<div class="webhook-card">
			<label><input type="checkbox" id="enableWebhook"> Enable Webhook Sending</label>
			
			<div id="webhookConfig" style="display:none; margin-top:12px;">
				
				<div class="webhook-url-container">
					<label>Webhook URL (replace with your URL after testing on webhook.site): <br/><input type="url" id="webhookUrl" value="" placeholder="Fetching unique webhook.site URL..."></label>
					<span id="webhookViewLink"></span> 
				</div>
				
				<label>Method: <select id="webhookMethod"><option>GET</option><option selected>POST</option><option>PUT</option></select></label>
				<label>Send every (seconds): <input type="number" id="webhookInterval" value="10" min="0" /><small>(0 = send on every packet)</small></label>
				
				<h4>Headers</h4>
				<div id="headersContainer"></div>
				<button id="addHeader" class="btn-secondary">+ Add header</button>
				<button id="clearHeaders" class="btn-secondary">Clear all headers</button>
				
				<h4>Body Template</h4>
				<textarea id="webhookBody" rows="14" style="width:100%;">{
	"software_version": "polluSensWeb 1.0",
	"timestamp": "{{ts}}",
	"sensordatavalues": [
	{{#fields}}
	{"value_type": "{{key}}", "value": "{{value}}"}
	{{/fields}}
	]
}</textarea>
				
				<div style="background:#f0f0f0; padding:10px; margin:10px 0; border-radius:4px; font-size:12px;">
					<strong>ðŸ“Š Debug Info:</strong>
					<div>Packets received: <span id="packetCount">0</span></div>
					<div>Webhooks sent: <span id="webhookCount">0</span></div>
				</div>
				<button id="testWebhook" class="btn-primary" style="margin-top:10px;">ðŸ§ª Test Send Webhook Now</button>
				<div id="statusLog"></div>
			</div>
		</div>
		
		<script src="pollusensweb.js"></script>

		<br/>
		<a href="https://github.com/WeSpeakEnglish/polluSensWeb" target="_blank" rel="noopener">
					<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="vertical-align: text-bottom; margin-right: 4px;">
					<path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
					</svg><div id="commit-date">Loadingâ€¦</div></a>
		
		<script>
			insertCommitDate();
		</script>
		
	</body>
</html>
